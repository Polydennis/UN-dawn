{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'quick-add.css' | asset_url | stylesheet_tag }}
<script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>
<script src="{{ 'quick-add.js' | asset_url }}" defer="defer"></script>

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

{% if cart.item_count > 0 %}
  {%- liquid
    assign base_product_id = cart.items.first.product.id
    assign base_product_price = cart.items.first.final_line_price
    assign cart_prefixes = '|'
    assign cart_product_ids = '|'
    assign has_accessory_in_cart = false
    assign accessory_type_a = 'tapetenzubehör'
    assign accessory_type_b = 'tapetenzubehor'

    for item in cart.items
      assign item_price = item.final_line_price
      if item_price > base_product_price
        assign base_product_price = item_price
        assign base_product_id = item.product.id
      endif

      assign item_type = item.product.type | downcase
      if item_type == accessory_type_a or item_type == accessory_type_b
        assign has_accessory_in_cart = true
      endif

      assign item_sku = item.variant.sku | default: ''
      if item_sku != blank
        assign item_prefix = item_sku | slice: 0, 4
        assign token = '|' | append: item_prefix | append: '|'
        unless cart_prefixes contains token
          assign cart_prefixes = cart_prefixes | append: item_prefix | append: '|'
        endunless
      endif

      assign item_product_id = item.product.id
      assign product_token = '|' | append: item_product_id | append: '|'
      unless cart_product_ids contains product_token
        assign cart_product_ids = cart_product_ids | append: item_product_id | append: '|'
      endunless
    endfor
  -%}
  <section class="cart-upsell color-{{ section.settings.color_scheme }} gradient section-{{ section.id }}-padding">
    <div class="page-width">
      <product-recommendations
        class="cart-upsell__recommendations"
        data-url="{{ routes.product_recommendations_url }}?limit={{ section.settings.limit }}&intent={{ section.settings.intent }}"
        data-section-id="{{ section.id }}"
        data-product-id="{{ base_product_id }}"
      >
        {% if recommendations.performed and recommendations.products_count > 0 %}
          {%- liquid
            assign has_motivwelt_match = false
            for recommendation in recommendations.products
              assign rec_sku = recommendation.selected_or_first_available_variant.sku | default: ''
              assign rec_prefix = rec_sku | slice: 0, 4
              assign token = '|' | append: rec_prefix | append: '|'
              if rec_prefix != blank and cart_prefixes contains token
                assign has_motivwelt_match = true
              endif
            endfor
          -%}

          {%- capture items_html -%}
            {% assign skip_card_product_styles = false %}
            {% for recommendation in recommendations.products %}
              {%- liquid
                assign rec_type = recommendation.type | downcase
                assign rec_sku = recommendation.selected_or_first_available_variant.sku | default: ''
                assign rec_prefix = rec_sku | slice: 0, 4
                assign rec_product_id = recommendation.id
                assign rec_product_token = '|' | append: rec_product_id | append: '|'
                assign include_item = true

                if cart_product_ids contains rec_product_token
                  assign include_item = false
                endif

                if has_accessory_in_cart and (rec_type == accessory_type_a or rec_type == accessory_type_b)
                  assign include_item = false
                endif

                if has_motivwelt_match
                  if rec_prefix == blank
                    assign include_item = false
                  else
                    assign token = '|' | append: rec_prefix | append: '|'
                    unless cart_prefixes contains token
                      assign include_item = false
                    endunless
                  endif
                endif
              -%}

              {% if include_item %}
                <li class="grid__item">
                  {% render 'card-product',
                    card_product: recommendation,
                    show_vendor: false,
                    show_rating: false,
                    quick_add: 'standard',
                    section_id: section.id,
                    skip_styles: skip_card_product_styles
                  %}
                </li>
                {%- assign skip_card_product_styles = true -%}
              {% endif %}
            {% endfor %}
          {%- endcapture -%}

          {%- assign items_html_stripped = items_html | strip -%}
          {% if items_html_stripped != blank %}
            <h2 class="title h3 cart-upsell__heading">{{ section.settings.heading }}</h2>
            <ul
              class="grid product-grid grid--4-col-desktop grid--2-col-tablet-down"
              role="list"
            >
              {{ items_html }}
            </ul>
          {% endif %}
        {% endif %}
      </product-recommendations>
    </div>
  </section>
{% endif %}

{% schema %}
{
  "name": "Cart upsell",
  "presets": [{ "name": "Cart upsell" }],
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Dazu passend" },
    { "type": "range", "id": "limit", "label": "Anzahl", "min": 1, "max": 10, "step": 1, "default": 4 },
    {
      "type": "select",
      "id": "intent",
      "label": "Intent",
      "default": "complementary",
      "options": [
        { "value": "complementary", "label": "Complementary (Upsell/Add-on)" },
        { "value": "related", "label": "Related (Ähnlich)" }
      ]
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "info": "t:sections.all.colors.has_cards_info",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 24
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 24
    }
  ]
}
{% endschema %}
